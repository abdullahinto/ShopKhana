{% extends 'index.html' %}

{% block title %}
ShopKhana - My Orders
{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/myorders.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/cancel-order.css') }}">
{% endblock extra_css %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/myorders.js') }}"></script>
{% endblock extra_js %}

{% block body %}
<section id="my-orders">
  <h2>My Orders</h2>

  <!-- Filters -->
  <div class="orders-filter">
    <label for="orderFilter">Filter by status:</label>
    <select id="orderFilter">
      <option value="all">All</option>
      <option value="delivered">Delivered</option>
      <option value="pending">Pending</option>
      <option value="canceled">Canceled</option>
    </select>
  </div>

  <!-- Orders Container -->
  <div class="orders-container">
    {% for order in orders %}
    <div class="order-card" data-status="{{ order.order_status | lower }}" data-order-id="{{ order.order_id }}">
      <div class="order-summary">
        <div class="order-info">
          <span class="order-number">Order #{{ order.display_order_number }}</span>
          <span class="order-date">{{ order.transaction_date_formatted }}</span>
          <span class="order-total">Total: Rs. {{ "{:,.0f}".format(order.payment_amount | default(0) | int) }}</span>
        </div>
        <div class="order-status {{ order.order_status | lower }}">{{ order.order_status }}</div>
        <div class="order-actions">
          <button class="track-btn" data-order-id="{{ order.order_id }}" {% if order.order_status | lower=="canceled" %}
            disabled style="pointer-events: none; opacity: 0.5;" {% endif %}>
            Track Shipment
          </button>
          {% if order.order_status | lower != "canceled" and order.order_status | lower != "delivered" %}
          <button class="cancel-order-btn" data-order-id="{{ order.order_id }}">Cancel Order</button>
          {% else %}
          <button class="cancel-order-btn" data-order-id="{{ order.order_id }}" disabled>Cancel Order</button>
          {% endif %}
          <a href="{{ url_for('download_invoice', order_id=order.order_id) }}" class="invoice-link" target="_blank" {%
            if order.order_status | lower=="canceled" %} style="pointer-events: none; opacity: 0.5;" {% endif %}>
            Download Invoice
          </a>
        </div>

        <div class="order-countdown">
          <span class="countdown">--:--:--</span>
        </div>


      </div>

      <!-- Expandable Order Details -->
      <div class="order-details">
        <p><strong>Item(s):</strong></p>
        <ul class="order-items">
          {# determine how many items there are #}
          {% set n_items = order.product_names | length %}
          {% for i in range(0, n_items) %}
          <li class="order-item" style="margin-left: 5px;">
            <span class="item-name">{{ order.product_names[i] }}</span>
            <span class="item-color">
              <b>Variation:</b> {{ order.product_colors[i] }}
            </span>
            <span class="item-qty"><b>Qty:</b> {{ order.product_quantities[i] }}</span>
          </li>
          {% endfor %}
        </ul>

        <p><strong>Shipping Address:</strong> {{ order.address }}, {{ order.province }}</p>
        <p><strong>Payment Method:</strong> {{ order.payment_method }}</p>
        <p>
          <strong>Tracking ID:</strong>
          <span class="tracking-id">{{ order.order_id }}</span>
          <button class="copy-tracking-btn">Copy</button>
        </p>
      </div>

    </div>
    {% endfor %}
  </div>

  <!-- Pagination Controls -->
  <div class="pagination">
    {% if pagination.current_page > 1 %}
    <a href="{{ url_for('my_orders', page=pagination.current_page - 1, sort=sort_order) }}"
      class="page-btn">Previous</a>
    {% else %}
    <span class="page-btn disabled">Previous</span>
    {% endif %}
    <span id="currentPage">{{ pagination.current_page }}</span>
    {% if pagination.current_page < pagination.total_pages %} <a
      href="{{ url_for('my_orders', page=pagination.current_page + 1, sort=sort_order) }}" class="page-btn">Next</a>
      {% else %}
      <span class="page-btn disabled">Next</span>
      {% endif %}
  </div>
</section>

<!-- Cancel Order Confirmation Popup (Reason Selection) -->
<div id="cancelOrderPopup" class="cancel-order-overlay">
  <!-- … your existing cancel popup … -->
</div>

<!-- Cancellation Not Allowed Popup -->
<div id="cancelNotAllowedPopup" class="dialog-overlay">
  <!-- … existing dialog … -->
</div>

<!-- Toast Notification Container -->
<div id="toast-container"></div>

<div id="confirmDialog" class="dialog-overlay" style="display: none;">
  <!-- … existing confirm dialog … -->
</div>
{% endblock body %}